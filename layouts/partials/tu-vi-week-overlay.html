{{/* =====================================================
     TỬ VI – WEEK ARCHIVE OVERLAY
     Chỉ hiển thị các tuần đã qua (tu_vi_archive)
===================================================== */}}

<!-- ===== TOGGLE BUTTON ===== -->
<button id="tuvi-week-toggle"
  aria-label="Xem các tuần đã qua"
  class="tuvi-week-btn dimmed">
  ☰
</button>

<!-- ===== OVERLAY PANEL ===== -->
<div id="tuvi-week-panel" class="tuvi-week-panel hidden dimmed">

  <div class="tuvi-week-header">
    <span>Các tuần đã qua</span>
    <button id="tuvi-week-close" aria-label="Đóng">✕</button>
  </div>

  <nav class="tuvi-week-content">

    <!-- ===== ARCHIVE WEEKS ===== -->
    <ul class="tuvi-week-group past-weeks">

      {{ with .Params.tu_vi_archive }}
        {{ range . }}
          <li>
            <button
              type="button"
              data-week="{{ .week_id }}"
              title="{{ .summary }}">
              Tuần {{ .tu_ngay }} → {{ .den_ngay }}
            </button>
          </li>
        {{ end }}
      {{ else }}
        <li class="tuvi-week-empty">
          Chưa có dữ liệu các tuần trước
        </li>
      {{ end }}

    </ul>

    <!-- ===== HOOK CHO THÁNG / NĂM (CHƯA DÙNG) ===== -->
    {{/* 
      DỰ KIẾN SAU:
      <ul class="tuvi-year-group">
        <li class="group-title">Năm 2026</li>
        <li>Tháng 01</li>
        <li>Tháng 02</li>
      </ul>
    */}}

  </nav>
</div>

<!-- ===== CSS ===== -->
<style>
.tuvi-week-btn {
  position: fixed;
  left: 16px;
  bottom: 22%;
  z-index: 50;
  padding: 10px 12px;
  border-radius: 999px;
  background: rgba(0,0,0,.65);
  color: #fff;
  font-size: 16px;
  transition: opacity .3s ease;
}

.tuvi-week-panel {
  position: fixed;
  left: 16px;
  bottom: calc(22% + 52px);
  width: 260px;
  max-height: 60vh;
  z-index: 60;
  background: rgba(255,255,255,.45);
  backdrop-filter: blur(10px);
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,.12);
  transition: opacity .3s ease;
}

.dimmed { opacity: .45; }

.tuvi-week-panel.active,
.tuvi-week-btn.active { opacity: 1; }

.hidden { display: none; }

.tuvi-week-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  font-weight: 600;
  font-size: 14px;
}

.tuvi-week-content {
  padding: 10px 14px;
  overflow-y: auto;
  font-size: 14px;
}

.tuvi-week-group {
  list-style: none;
  padding-left: 0;
  margin-bottom: 10px;
}

.tuvi-week-group li {
  margin: 6px 0;
}

.tuvi-week-group button {
  background: none;
  border: none;
  padding: 0;
  font-size: 14px;
  cursor: pointer;
  color: #111;
  text-align: left;
}

.tuvi-week-empty {
  font-size: 13px;
  opacity: .6;
  font-style: italic;
}

@media (max-width: 768px) {
  .tuvi-week-panel {
    width: 88%;
    max-width: 320px;
    bottom: 18%;
    background: rgba(255,255,255,.30);
  }
  .dimmed { opacity: .35; }
}
</style>

<!-- ===== JS ===== -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("tuvi-week-toggle");
  const panel = document.getElementById("tuvi-week-panel");
  const closeBtn = document.getElementById("tuvi-week-close");

  if (!toggle || !panel) return;

  let dimTimer;

  function activate() {
    toggle.classList.add("active");
    toggle.classList.remove("dimmed");
    panel.classList.add("active");
    panel.classList.remove("dimmed");
    clearTimeout(dimTimer);
  }

  function autoDim() {
    clearTimeout(dimTimer);
    dimTimer = setTimeout(() => {
      toggle.classList.remove("active");
      toggle.classList.add("dimmed");
      panel.classList.remove("active");
      panel.classList.add("dimmed");
    }, 2000);
  }

  function hidePanel() {
    panel.classList.add("hidden");
    autoDim();
  }

  toggle.addEventListener("click", (e) => {
    e.stopPropagation();
    panel.classList.remove("hidden");
    activate();
    autoDim();
  });

  closeBtn?.addEventListener("click", hidePanel);

  document.addEventListener("click", (e) => {
    if (!panel.contains(e.target) && !toggle.contains(e.target)) {
      hidePanel();
    }
  });

  document.addEventListener("touchstart", (e) => {
    if (!panel.contains(e.target) && !toggle.contains(e.target)) {
      hidePanel();
    }
  });

  window.addEventListener("scroll", autoDim, { passive: true });

  panel.addEventListener("mouseenter", activate);
  panel.addEventListener("touchstart", activate);

  autoDim();
});

document.addEventListener("DOMContentLoaded", function () {
  const panel = document.getElementById("tuvi-week-panel");

  if (!panel) return;

  panel.querySelectorAll("button[data-week]").forEach(btn => {
    btn.addEventListener("click", () => {
      let summary = btn.getAttribute("data-summary") || btn.getAttribute("title");
      if (!summary) return;

      let existing = btn.parentElement.querySelector(".tuvi-week-summary");

      // Toggle summary
      if (existing) {
        existing.remove();
      } else {
        let div = document.createElement("div");
        div.className = "tuvi-week-summary";
        div.textContent = summary;
        btn.parentElement.appendChild(div);
      }
    });
  });
});
</script>

