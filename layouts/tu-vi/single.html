{{ define "main" }}

{{ $tuvi := index site.Data "tu-vi" }}
{{ $kichban := index $tuvi "kich-ban-viet" }}
{{ $chude := index $tuvi "chu-de-tuan" }}

{{ $cungKey := .Params.cung | default .File.TranslationBaseName }}
{{ $cungData := index $tuvi "cung-hoang-dao" }}
{{ $cung := index $cungData $cungKey }}

{{/* ===== T·ª∞ D√í NƒÇM T·ª¨ VI M·ªöI NH·∫§T ===== */}}
{{ $year := "" }}
{{ range where .Site.RegularPages "Section" "tu-vi" }}
  {{ if findRE `^/tu-vi/nam-[0-9]{4}/` .RelPermalink }}
    {{ $y := replaceRE `^/tu-vi/nam-([0-9]{4})/.*` "$1" .RelPermalink }}
    {{ if or (eq $year "") (gt $y $year) }}
      {{ $year = $y }}
    {{ end }}
  {{ end }}
{{ end }}

<article class="tarot-article tu-vi-article">

  <!-- ===== HEADER ===== -->
  <header class="tarot-header">

    <h1 class="tarot-title">{{ .Title }}</h1>
    
    {{ with .Params.tu_vi_tuan }}
    <div class="tu-vi-meta">
      <button class="tu-vi-week-toggle" aria-expanded="false">
        Tu·∫ßn {{ .tu_ngay }} ‚Üí {{ .den_ngay }}
      </button>
    </div>
    {{ end }}
  
    {{ partial "tu-vi-cung-date.html" . }}

    {{ with .Params.image }}
      <figure class="tarot-figure">
        <img src="{{ . }}" alt="Cung {{ $cung.ten }}">
      </figure>
    {{ end }}

    <div class="tarot-summary">
      {{ $intro := index $kichban.mo_bai (mod (now.Unix) (len $kichban.mo_bai)) }}
      {{ replace $intro "{{ten_cung}}" $cung.ten }}
    </div>

  </header>

  <!-- ===== CONTENT ===== -->
  <div class="tarot-content">

    {{ partial "tu-vi-week-overlay.html" . }}

    <!-- ===== T·ªîNG QUAN ===== -->
    <h2>T·ªïng quan {{ $cung.ten }}</h2>
    <ul>
      {{ with $cung.nguyen_to }}<li><strong>Nguy√™n t·ªë:</strong> {{ . }}</li>{{ end }}
      {{ with $cung.tinh_cach.diem_manh }}<li><strong>ƒêi·ªÉm m·∫°nh:</strong> {{ delimit . ", " }}</li>{{ end }}
      {{ with $cung.tinh_cach.diem_yeu }}<li><strong>ƒêi·ªÉm y·∫øu:</strong> {{ delimit . ", " }}</li>{{ end }}
      {{ with $cung.mau_may_man }}<li><strong>M√†u may m·∫Øn:</strong> {{ . }}</li>{{ end }}
    </ul>

    <!-- ===== TU·∫¶N HI·ªÜN T·∫†I ===== -->
    {{ with .Params.tu_vi_tuan }}
    <section class="tu-vi-week current-week">
      <h2>üîÆ D·ª± ƒëo√°n tu·∫ßn n√†y ({{ .tu_ngay }} ‚Üí {{ .den_ngay }})</h2>

      {{ with $chude.cong_viec }}
        <h3>C√¥ng vi·ªác</h3>
        <p>{{ index . (mod (now.Unix) (len .)) }}</p>
      {{ end }}

      {{ with $chude.tinh_cam }}
        <h3>T√¨nh c·∫£m</h3>
        <p>{{ index . (mod (add (now.Unix) 3) (len .)) }}</p>
      {{ end }}

      {{ with $chude.tai_chinh }}
        <h3>T√†i ch√≠nh</h3>
        <p>{{ index . (mod (add (now.Unix) 7) (len .)) }}</p>
      {{ end }}
    </section>
    {{ end }}

    <!-- ===== üîó G·ª¢I √ù XEM T·ª¨ VI NƒÇM (CH·ªà HI·ªÜN KHI C√ì DATA) ===== -->
    {{ if $year }}
    <section class="tu-vi-year-suggest">
      <p>
        üëâ Ngo√†i di·ªÖn bi·∫øn theo tu·∫ßn, t·ª≠ vi nƒÉm s·∫Ω gi√∫p b·∫°n th·∫•y b·ª©c tranh d√†i h·∫°n r√µ h∆°n.
        Xem chi ti·∫øt t·∫°i
        <a href="/tu-vi/nam-{{ $year }}/{{ $cungKey }}/">
          <strong>T·ª≠ vi nƒÉm {{ $year }} cung {{ $cung.ten }}</strong>
        </a>.
      </p>
    </section>
    {{ end }}

    <!-- ===== TU·∫¶N K·∫æ TI·∫æP ===== -->
    {{ with .Params.tu_vi_next }}
    <section class="tu-vi-week next-week">
      <h2>üìÖ Tu·∫ßn k·∫ø ti·∫øp ({{ .tu_ngay }} ‚Üí {{ .den_ngay }})</h2>

      <p class="tu-vi-next-note">
        ƒê√¢y l√† xu h∆∞·ªõng t·ªïng quan cho tu·∫ßn k·∫ø ti·∫øp.
        N·ªôi dung chi ti·∫øt s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t khi b∆∞·ªõc sang tu·∫ßn m·ªõi.
      </p>
    </section>
    {{ end }}

  </div>

  <!-- ===== FOOTER ===== -->
  <footer class="tarot-footer">
    {{ $outro := index $kichban.ket_bai (mod (add (now.Unix) 11) (len $kichban.ket_bai)) }}
    {{ replace $outro "{{ten_cung}}" $cung.ten }}
  </footer>

</article>

<!-- ===== CSS NH·∫∏ CHO G·ª¢I √ù T·ª¨ VI NƒÇM ===== -->
<style>
.tu-vi-year-suggest {
  margin: 28px 0;
  padding: 14px 18px;
  border-left: 4px solid #c40000;
  background: rgba(196, 0, 0, 0.06);
  border-radius: 6px;
  font-size: 15px;
}

.tu-vi-year-suggest a {
  color: #c40000;
  text-decoration: none;
}

.tu-vi-year-suggest a:hover {
  text-decoration: underline;
}
</style>

{{ end }}
