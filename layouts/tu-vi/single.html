{{ define "main" }}

{{ $tuvi := index site.Data "tu-vi" }}
{{ $tuan := index $tuvi "thong-tin-tuan" }}
{{ $kichban := index $tuvi "kich-ban-viet" }}
{{ $chude := index $tuvi "chu-de-tuan" }}

{{ $cungKey := .Params.cung | default .File.TranslationBaseName }}
{{ $cungData := index $tuvi "cung-hoang-dao" }}
{{ $cung := index $cungData $cungKey }}

<article class="tarot-article tu-vi-article">

  <!-- ===== HEADER ===== -->
  <header class="tarot-header">

    <h1 class="tarot-title">{{ .Title }}</h1>

    <div class="tu-vi-meta">
      <button class="tu-vi-week-toggle" aria-expanded="false">
        Tuần {{ $tuan.tu_ngay }} → {{ $tuan.den_ngay }}
      </button>
    </div>

    {{ with .Params.image }}
      <figure class="tarot-figure">
        <img src="{{ . }}" alt="Cung {{ $cung.ten }}">
      </figure>
    {{ end }}

    <div class="tarot-summary">
      {{ $intro := index $kichban.mo_bai (mod (now.Unix) (len $kichban.mo_bai)) }}
      {{ replace $intro "{{ten_cung}}" $cung.ten }}
    </div>

  </header>

  <!-- ===== CONTENT ===== -->
  <div class="tarot-content">
    
{{ partial "tu-vi-week-overlay.html" . }}

    <h2>Tổng quan {{ $cung.ten }}</h2>
    <ul>
      {{ with $cung.nguyen_to }}<li><strong>Nguyên tố:</strong> {{ . }}</li>{{ end }}
      {{ with $cung.tinh_cach.diem_manh }}<li><strong>Điểm mạnh:</strong> {{ delimit . ", " }}</li>{{ end }}
      {{ with $cung.tinh_cach.diem_yeu }}<li><strong>Điểm yếu:</strong> {{ delimit . ", " }}</li>{{ end }}
      {{ with $cung.mau_may_man }}<li><strong>Màu may mắn:</strong> {{ . }}</li>{{ end }}
    </ul>

    <h2>Dự đoán tuần này</h2>

    {{ with $chude.cong_viec }}
      <h3>Công việc</h3>
      <p>{{ index . (mod (now.Unix) (len .)) }}</p>
    {{ end }}

    {{ with $chude.tinh_cam }}
      <h3>Tình cảm</h3>
      <p>{{ index . (mod (add (now.Unix) 3) (len .)) }}</p>
    {{ end }}

    {{ with $chude.tai_chinh }}
      <h3>Tài chính</h3>
      <p>{{ index . (mod (add (now.Unix) 7) (len .)) }}</p>
    {{ end }}

  </div>

  <!-- ===== TUẦN CŨ (ẨN) ===== -->
  <div class="tu-vi-old-weeks" hidden>
    <!-- để trống, sau này mở rộng -->
  </div>

  <!-- ===== FOOTER ===== -->
  <footer class="tarot-footer">
    {{ $outro := index $kichban.ket_bai (mod (add (now.Unix) 11) (len $kichban.ket_bai)) }}
    {{ replace $outro "{{ten_cung}}" $cung.ten }}
  </footer>

</article>

<!-- ===== TOGGLE TUẦN ===== -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('.tu-vi-week-toggle');
  const old = document.querySelector('.tu-vi-old-weeks');
  if (!btn || !old) return;
  btn.addEventListener('click', () => {
    const open = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', !open);
    old.hidden = open;
  });
});
</script>

{{ end }}
