document.addEventListener("DOMContentLoaded",()=>{const s=!0;function t(...e){s&&console.log("[TAROT]",...e)}function m(...e){s&&console.warn("[TAROT]",...e)}function d(...e){console.error("[TAROT]",...e)}const A=document.querySelector(".tarot-shuffle-box button"),c=document.querySelector(".tarot-deck"),v=document.querySelector(".tarot-spread-area"),w=document.querySelectorAll(".tarot-slot"),i=document.getElementById("reveal-reading"),S=document.getElementById("reset-tarot"),o=document.getElementById("tarot-reading"),u=document.getElementById("reading-1"),h=document.getElementById("reading-2"),r=document.getElementById("reading-3"),y=document.querySelector(".tarot-panel"),j=document.getElementById("tarot-data");let e=[];if(j)try{const t=JSON.parse(j.textContent);e=Array.isArray(t)?t:Object.values(t)}catch(e){d("Invalid tarot-data JSON",e)}else d("Missing #tarot-data element");const l="https://cdn.jsdelivr.net/gh/cuongpham0212/kho-anh@main/tarot/anh-mat-sau-la-bai-tarot.webp";if(s&&(t("cards length =",Array.isArray(e)?e.length:"NOT ARRAY"),Array.isArray(e)&&e.length)){const n=e.find(e=>e&&(e.title||e.slug));t("sample card =",n);const s=e.filter(e=>!e?.image).length;t("cards missing image =",s)}let O=[],f=0,n=[],g=!1,a=!1;const C=24,x=["past","present","future"];function p(e){return{title:e?.title??"",slug:e?.slug??"",image:e?.image??"",reading:e?.reading??{}}}function E(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function k(){const i=e.map(p),n=Array.from({length:i.length},(e,t)=>t);E(n);const o=n.map((e,t)=>({deckIndex:t,cardIndex:e,isReversed:Math.random()<.5,drawn:!1}));if(s){const n=o.slice(0,3).map(t=>{const n=p(e[t.cardIndex]);return{deckIndex:t.deckIndex,title:n.title,image:n.image,reversed:t.isReversed}});t("deck built. first3 =",n)}return o}function _(t){const n=e[t.cardIndex];return p(n)}function b(){v.innerHTML="",w.forEach(e=>{e.innerHTML="",e.style.background="none"}),n=[],f=0,g=!1,a=!1,i.disabled=!0,i.classList.add("is-disabled"),u&&(u.textContent=""),h&&(h.textContent=""),r&&(r.textContent=""),o&&(o.hidden=!0),document.body.classList.remove("tarot-shuffled","tarot-after"),document.body.classList.add("tarot-before"),y?.classList.remove("is-active")}function M(){if(!c)return;c.classList.add("is-shuffling");const e=c.querySelectorAll("img");e.forEach((e,t)=>{e.style.setProperty("--sx",`${(Math.random()-.5)*18}px`),e.style.setProperty("--sy",`${(Math.random()-.5)*12}px`),e.style.setProperty("--sr",`${(Math.random()-.5)*10}deg`),e.style.setProperty("--sz",`${t*3}px`)}),setTimeout(()=>{c.classList.remove("is-shuffling"),e.forEach((e,t)=>{e.style.setProperty("--sx",`0px`),e.style.setProperty("--sy",`0px`),e.style.setProperty("--sr",`0deg`),e.style.setProperty("--sz",`${t*3}px`)})},600)}function F(){v.innerHTML="";const e=C,t=320,n=100,s=18;for(let i=0;i<e;i++){const o=document.createElement("img");o.src=l,o.className="tarot-card tarot-spread-card",o.style.setProperty("--x","0px"),o.style.setProperty("--y","0px"),o.style.setProperty("--r","0deg"),o.style.opacity="0",o.style.pointerEvents="none",v.appendChild(o);const r=i/(e-1),a=Math.PI*(r-.5),c=Math.sin(a)*t,d=-Math.cos(a)*n,u=a*s;setTimeout(()=>{o.style.opacity="1",o.style.pointerEvents="auto",o.classList.add("is-dealt"),o.style.setProperty("--x",`${c}px`),o.style.setProperty("--y",`${d}px`),o.style.setProperty("--r",`${u}deg`)},i*18),o.addEventListener("click",()=>T(o))}g=!0,document.body.classList.remove("tarot-before"),document.body.classList.add("tarot-shuffled")}function T(e){if(!g||a)return;if(n.length>=3)return;const r=O[f];if(!r)return;a=!0,r.drawn=!0,f++,n.push(r),e.classList.add("is-picked"),e.style.pointerEvents="none",e.style.opacity="0.35";const c=w[n.length-1];if(!c){a=!1;return}const u=e.getBoundingClientRect(),h=c.getBoundingClientRect(),o=document.createElement("img");o.src=l,o.className="tarot-card tarot-fly-card",document.body.appendChild(o),o.style.left=`${u.left}px`,o.style.top=`${u.top}px`,o.style.width=`${u.width}px`,o.style.height=`${u.height}px`,requestAnimationFrame(()=>{o.style.transform=`
        translate(${h.left-u.left}px, ${h.top-u.top}px)
        scale(0.95)
      `}),setTimeout(()=>{o.remove();const u=_(r);s&&(t("picked item =",r),t("picked card =",{title:u.title,slug:u.slug,image:u.image})),c.innerHTML="",c.style.background="none";const e=document.createElement("img");e.alt=u.title||u.slug||"Tarot card",e.className="tarot-selected-card",u.image?e.src=u.image:(m("Missing image for card:",u.title||u.slug,"=> fallback BACK_IMAGE"),e.src=l),e.onerror=()=>{d("Image failed to load:",e.src,"card =",u),e.src=l},r.isReversed?(e.classList.add("is-reversed"),e.style.transform="rotate(180deg)"):e.style.transform="rotate(0deg)",c.appendChild(e),s&&setTimeout(()=>{const e=c.querySelector("img");t("slot img src =",e?.getAttribute("src")),t("slot img currentSrc =",e?.currentSrc)},0),a=!1,n.length===3&&(i.disabled=!1,i.classList.remove("is-disabled"))},420)}function z(){if(n.length!==3)return;const e=n.map((e,t)=>{const s=x[t],n=_(e),o=n.reading?.[s];if(!o)return m("Missing reading node:",n.title||n.slug,"pos =",s,"reading =",n.reading),"";const i=e.isReversed?o.reversed||"":o.upright||"";return i||m("Empty reading text:",n.title||n.slug,"pos =",s,"reversed =",e.isReversed),i});u&&(u.textContent=e[0]||""),h&&(h.textContent=e[1]||""),r&&(r.textContent=e[2]||""),o&&(o.hidden=!1),s&&t("reading rendered. lengths =",e.map(e=>(e||"").length))}A?.addEventListener("click",()=>{if(b(),!Array.isArray(e)||e.length<10){d("Tarot cards not loaded or too few:",e);return}O=k(),M(),setTimeout(F,550)}),i?.addEventListener("click",()=>{if(n.length!==3)return;document.body.classList.add("tarot-after"),y?.classList.add("is-active"),o&&(o.hidden=!1),z(),o?.scrollIntoView({behavior:"smooth",block:"start"})}),S?.addEventListener("click",()=>{b()})})