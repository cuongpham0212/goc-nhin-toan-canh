document.addEventListener("DOMContentLoaded",()=>{const d=document.getElementById("tarot-data");if(!d)return;let e;try{e=JSON.parse(d.textContent),typeof e=="string"&&(e=JSON.parse(e))}catch(e){console.error("Invalid tarot-data JSON",e);return}if(!Array.isArray(e)||e.length===0)return;const a="https://cdn.jsdelivr.net/gh/cuongpham0212/kho-anh@main/tarot/anh-mat-sau-la-bai-tarot.webp",w=.5,r=["past","present","future"],c=document.querySelectorAll(".tarot-slot"),l=document.getElementById("reveal-reading"),o=document.getElementById("tarot-overlay"),_=document.querySelector(".tarot-panel"),u=document.getElementById("tarot-reading"),f=document.getElementById("reading-1"),y=document.getElementById("reading-2"),b=document.getElementById("reading-3");if(c.length!==3)return;function s(e){if(typeof e!="string")return e;const t=e.trim();return t.length>=2&&t[0]==='"'&&t[t.length-1]==='"'?t.slice(1,-1):t}function n(e){if(e==null)return e;if(typeof e=="string"){let t=e.trim();if(t=s(t),t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]"))try{return JSON.parse(t)}catch{return t}return t}return e}function p(e){const t={...e};return t.title=s(n(t.title)),t.slug=s(n(t.slug)),t.image=s(n(t.image)),t.summary=s(n(t.summary)),t.emotion=n(t.emotion),t.guidance=n(t.guidance),t.reading=n(t.reading),t}e=e.map(p);function g(e){const t=Math.floor(Math.random()*e.length);return e.splice(t,1)[0]}function v(){return Math.random()<w}function h(e,t=!1){const n=document.createElement("div");n.className="tarot-card",t&&n.classList.add("is-reversed");const s=document.createElement("div");s.className="tarot-face back",s.innerHTML=`<img src="${a}" alt="Tarot back">`;const o=document.createElement("div");return o.className="tarot-face front",o.innerHTML=`<img src="${e}" alt="Tarot front">`,n.appendChild(s),n.appendChild(o),n}function j(e){return Array.isArray(e)?e.join(", "):e==null?"":String(e)}function i(e,t,n,s){const i=e?.reading,o=i?.[n];if(o&&typeof o=="object"){const e=t?o.reversed||o.upright||"":o.upright||o.reversed||"";if(e)return String(e).trim()}const a=e?.[s]??e?.summary??"";return j(a).trim()}let m=e.map((e,t)=>t),t=[];c.forEach(e=>{e.innerHTML="",e.appendChild(h(a))}),c.forEach((n,s)=>{n.addEventListener("click",()=>{if(t[s])return;if(!m.length)return;const r=g(m),c=e[r],i=v(),o={...c,isReversed:i};t[s]=o;const d=o.image&&String(o.image).trim()?String(o.image).trim():a;n.innerHTML="",n.appendChild(h(d,i)),requestAnimationFrame(()=>{n.querySelector(".tarot-card")?.classList.add("is-flipped")}),t.filter(Boolean).length===3&&(l.disabled=!1)})}),l.addEventListener("click",()=>{if(t.filter(Boolean).length!==3)return;o&&(o.hidden=!1),setTimeout(()=>{document.body.classList.remove("tarot-before"),document.body.classList.add("tarot-after"),_?.classList.add("is-active"),f.textContent=i(t[0],t[0].isReversed,r[0],"summary"),y.textContent=i(t[1],t[1].isReversed,r[1],"emotion"),b.textContent=i(t[2],t[2].isReversed,r[2],"guidance"),u.hidden=!1,o&&(o.hidden=!0),u.scrollIntoView({behavior:"smooth",block:"start"})},1200)})})