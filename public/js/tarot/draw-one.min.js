document.addEventListener("DOMContentLoaded",()=>{const h=document.getElementById("tarot-data");if(!h)return;let e;try{e=JSON.parse(h.textContent),typeof e=="string"&&(e=JSON.parse(e))}catch(e){console.error("Invalid tarot-data JSON",e);return}if(!Array.isArray(e)||e.length<3)return;const m="https://cdn.jsdelivr.net/gh/cuongpham0212/kho-anh@main/tarot/anh-mat-sau-la-bai-tarot.webp",O=.5,x=["past","present","future"],a=document.querySelectorAll(".tarot-slot"),n=document.getElementById("reveal-reading"),j=document.getElementById("reset-tarot"),o=document.getElementById("tarot-overlay"),u=document.querySelector(".tarot-panel"),r=document.getElementById("tarot-reading"),g=document.getElementById("reading-1"),f=document.getElementById("reading-2"),p=document.getElementById("reading-3");if(a.length!==3)return;let s=[],t=[],c=0;function v(){const e=Math.floor(Math.random()*s.length);return s.splice(e,1)[0]}function b(){return Math.random()<O}function l(){return c===3&&t.length===3&&t.every(e=>e&&typeof e=="object")}function y(){l()&&(n.disabled=!1,n.classList.remove("is-disabled"))}function _(){a.forEach(e=>{e.innerHTML="",e.classList.remove("is-locked");const t=document.createElement("div");t.className="tarot-card";const n=document.createElement("div");n.className="tarot-face back",n.innerHTML=`<img src="${m}" alt="">`;const s=document.createElement("div");s.className="tarot-face front",s.innerHTML=`<img src="" alt="">`,t.appendChild(n),t.appendChild(s),e.appendChild(t)})}function w(){a.forEach((n,o)=>{n.onclick=null,n.onclick=()=>{if(n.classList.contains("is-locked"))return;if(!s.length)return;n.classList.add("is-locked");const u=v(),i=e[u],r=b();t[o]={...i,isReversed:r};const a=n.querySelector(".tarot-card"),h=a.querySelector(".tarot-face.front img"),l=i.image&&String(i.image).trim()?String(i.image).trim():m,d=new Image;d.src=l,d.onload=()=>{h.src=l,a.classList.toggle("is-reversed",r),a.getBoundingClientRect(),requestAnimationFrame(()=>{a.classList.add("is-flipped")}),c++,y()}}})}function d(){s=e.map((e,t)=>t),t=new Array(3).fill(null),c=0,n.disabled=!0,n.classList.add("is-disabled"),n.hidden=!1,r.hidden=!0,u?.classList.remove("is-active"),document.body.classList.add("tarot-before"),document.body.classList.remove("tarot-after"),_(),w()}function i(e,t,n){if(!e)return"";const s=e.reading?.[t];return s&&typeof s=="object"?e.isReversed?s.reversed||s.upright||"":s.upright||s.reversed||"":e[n]||e.summary||""}n.addEventListener("click",()=>{if(!l())return;o&&(o.hidden=!1),setTimeout(()=>{document.body.classList.remove("tarot-before"),document.body.classList.add("tarot-after"),u?.classList.add("is-active"),g.textContent=i(t[0],"past","summary"),f.textContent=i(t[1],"present","emotion"),p.textContent=i(t[2],"future","guidance"),r.hidden=!1,o&&(o.hidden=!0),r.scrollIntoView({behavior:"smooth"})},600)}),j?.addEventListener("click",d),d()})